# Makefile for greyd.
# @configure_input@

progname = @PACKAGE_NAME@
package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = @PACKAGE_TARNAME@
distdir = $(tarname)-$(version)

prefix = @prefix@
exec_prefix = @exec_prefix@
sbindir = @sbindir@
libdir = @libdir@
sysconfdir = @sysconfdir@
localstatedir = @localstatedir@

srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
CFLAGS = -I. -I$(srcdir) -I.. @CFLAGS@
CPPFLAGS = @CPPFLAGS@
LDFLAGS = @LDFLAGS@ -Wl,-E

greyd_LIBS = @greyd_LIBS@
greylogd_LIBS = @greylogd_LIBS@
greydb_LIBS = @greydb_LIBS@
greyd_setup_LIBS = @greyd_setup_LIBS@

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@

SRC = blacklist.c con.c config_lexer.c config_parser.c config_section.c config_value.c failures.c firewall.c grey.c greydb.c greyd.c greyd_config.c hash.c ip.c lexer.c lexer_source.c list.c log.c main_greydb.c main_greyd.c main_greyd_setup.c main_greylogd.c mod.c queue.c spamd_lexer.c spamd_parser.c sync.c utils.c
MAINS_SRC = main_greydb.c  main_greyd.c  main_greyd_setup.c  main_greylogd.c
MAINS = $(MAINS_SRC:.c=.o)
OBJ = $(SRC:.c=.o)
TESTS = tests

all: greyd greyd-setup greydb greylogd modules

greyd: $(OBJ)
	$(CC) $(CFLAGS) $(LDFLAGS) -o greyd main_greyd.o $(filter-out $(MAINS),$(OBJ)) $(greyd_LIBS)

greylogd: $(OBJ)
	$(CC) $(CFLAGS) $(LDFLAGS) -o greylogd main_greylogd.o $(filter-out $(MAINS),$(OBJ)) $(greylogd_LIBS)

greydb: $(OBJ)
	$(CC) $(CFLAGS) $(LDFLAGS) -o greydb main_greydb.o $(filter-out $(MAINS),$(OBJ)) $(greydb_LIBS)

greyd-setup: $(OBJ)
	$(CC) $(CFLAGS) $(LDFLAGS) -o greyd-setup main_greyd_setup.o $(filter-out $(MAINS),$(OBJ)) $(greyd_setup_LIBS)

modules:
	$(MAKE) -C modules

install:
	$(INSTALL) -d $(DESTDIR)$(sbindir)
	$(INSTALL_PROGRAM) -m 0750 greyd $(DESTDIR)$(sbindir)
	$(INSTALL_PROGRAM) -m 0750 greylogd $(DESTDIR)$(sbindir)
	$(INSTALL_PROGRAM) -m 0750 greydb $(DESTDIR)$(sbindir)
	$(INSTALL_PROGRAM) -m 0750 greyd-setup $(DESTDIR)$(sbindir)
	$(MAKE) -C modules/ $@

#
# Generate the object file header dependencies.
#
%.d:%.c
	@set -e; rm -f $@; \
	$(CC) -M $(CFLAGS) $< > $@.$$$$; \
    sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
    rm -f $@.$$$$

-include $(SRC:.c=.d)

.PHONY: clean modules install

clean:
	rm -f $(OBJ) $(MAINS) $(SRC:.c=.d) $(SRC:.c=.d).* greyd-setup greydb greyd greylogd
	$(MAKE) -C modules $@
