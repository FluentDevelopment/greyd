# Makefile for greyd unit tests.
# @configure_input@

progname = @PACKAGE_NAME@
package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = @PACKAGE_TARNAME@
distdir = $(tarname)-$(version)

prefix = @prefix@
exec_prefix = @exec_prefix@
sbindir = @sbindir@
libdir = @libdir@
sysconfdir = @sysconfdir@
localstatedir = @localstatedir@

srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
CFLAGS = -I$(srcdir)/../src @CFLAGS@
LIBS = @LIBS@

SRC	= test.c
TESTS = test_bdb.c test_blacklist.c test_con.c test_config.c test_config_lexer.c test_config_parser.c test_config_section.c test_config_value.c test_grey.c test_greyd_utils.c test_hash.c test_ip.c test_lexer_source.c test_list.c test_queue.c test_spamd_lexer.c test_spamd_parser.c test_test_framework.c
TEST_OBJ = $(SRC:.c=.o) $(TESTS:.c=.o)
TARGETS	= $(TESTS:.c=.t)

all: $(TARGETS)

test_%.t: test_%.o $(TEST_OBJ)
	$(CC) $(CFLAGS) $(LIBS) -Wl,-E -o $@ $< $(SRC:.c=.o) $(shell find ../src -maxdepth 1 -name \*.o -and -not -name main_\*)

clean:
	rm -f $(TARGETS) $(TEST_OBJ)

test check: $(TARGETS)
	@echo
	@echo "******************************"
	@echo "** Preparing to run tests...**"
	@echo "******************************"
	@echo
	LD_LIBRARY_PATH=/usr/local/BerkeleyDB.5.3/lib perl run_tests.pl ./*.t

.PHONY: clean
